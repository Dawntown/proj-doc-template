% Style settings for report
% Referenced from ReadBooksWeekly/preamble.tex
% Note: natbib configuration (authoryear or numbers) should be done in report.tex
% before \input{preamble.tex}

% Pass options to packages before loading preamble_base
\PassOptionsToPackage{usenames,dvipsnames}{xcolor}
\PassOptionsToPackage{most,many,breakable}{tcolorbox}

\input{../preamble_base.tex}

% Additional packages for report
\usepackage[shortlabels]{enumitem}
\setlist{nolistsep}
\usepackage{framed}
\usepackage{multirow}
\usepackage{ulem}
\usepackage{listings}
\usepackage{fancyvrb}
\usepackage{empheq}
\usepackage{multicol}
\usepackage{cancel}
\usepackage{pdfpages}
\usepackage{tikzsymbols}
\renewcommand\qedsymbol{$\Laughey$}
\usepackage{geometry}
\usepackage{lineno}

% Paragraph settings
\setlength{\parskip}{5pt}

% Table settings
\setlength{\tabcolsep}{5pt}
\renewcommand\arraystretch{1.5}

% Code blocks style
\lstset{ 
  language=R,
  basicstyle=\footnotesize\ttfamily,
  numbers=left,
  numberstyle=\footnotesize\color{blue},
  stepnumber=1,
  numbersep=5pt,
  backgroundcolor=\color{white},
  showspaces=false,
  showstringspaces=false,
  showtabs=false,
  frame=single,
  rulecolor=\color{black},
  tabsize=2,
  captionpos=b,
  breaklines=true,
  breakatwhitespace=false,
  keywordstyle=\color{blue},
  commentstyle=\color{green},
  stringstyle=\color{green},
  title=\lstname
} 

% SI Unit settings
\usepackage{siunitx}
\sisetup{locale = FR}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                               Custom Commands                               %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                 Environments                                %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{varwidth}
\usepackage{thmtools}
% tcolorbox already loaded in preamble_base with options passed above
\usepackage[framemethod=TikZ]{mdframed}

\tcbuselibrary{theorems,skins,hooks}
\usetikzlibrary{arrows,calc,shadows.blur}

%%%%%%%%%%%%%%%%%%%
%  Define Colors  %
%%%%%%%%%%%%%%%%%%%

% Base colors harmonized with CUHK theme
\definecolor{cuhkpurple}{RGB}{117, 15, 109}    % CUHK primary purple
\definecolor{cuhkgold}{RGB}{221, 163, 0}       % CUHK gold
\definecolor{cuhkbeige}{RGB}{244, 223, 176}    % CUHK beige

% Theme colors (harmonized palette)
\definecolor{myblue}{RGB}{45, 111, 177}        % Complementary blue
\definecolor{mygreen}{RGB}{56, 140, 70}        % Nature green
\definecolor{myorange}{RGB}{255, 140, 0}      % Warm orange
\definecolor{mypurple}{RGB}{117, 15, 109}      % Matching CUHK purple
\definecolor{myteal}{RGB}{0, 128, 128}         % Teal accent

% Environment colors (harmonized with theme - softened for subtlety)
\colorlet{theorem}{cuhkpurple!65!black}       % Soft purple for theorems
\colorlet{lemma}{cuhkpurple!55!blue}          % Soft purple-blue for lemmas
\colorlet{corollary}{cuhkpurple!50!mypurple}  % Soft purple variant for corollaries
\colorlet{prop}{cuhkpurple!60!black}          % Soft purple for propositions
\colorlet{claim}{myteal!60!black}             % Soft teal for claims
\colorlet{definition}{mygreen!60!black}       % Soft green for definitions
\colorlet{example}{cuhkgold!65!black}        % Soft gold for examples
\colorlet{exercise}{myorange!55!black}       % Soft orange for exercises
\colorlet{proof}{theorem}                     % Same as theorem

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Generic Style System Based on Colors and Styles      %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\mdfsetup{skipabove=1em,skipbelow=0em}

%%%%%%%%%%%%%%%%%%%%%%
%  Generic Style Commands  %
%%%%%%%%%%%%%%%%%%%%%%

% Style 1: Vertical line on left (for theorems, proofs, exercises)
\newcommand\createnewvertlinestyle[4]{
  \declaretheoremstyle[
  headfont=\bfseries\sffamily\color{#2}, bodyfont=\normalfont, #3,
  mdframed={
    linewidth=2pt,
    rightline=false, leftline=true, topline=false, bottomline=false,
    linecolor=#2!70!black, 
    backgroundcolor=#2!4,
    roundcorner=3pt,
    innertopmargin=6pt,
    innerbottommargin=6pt,
    innerleftmargin=8pt,
    innerrightmargin=8pt,
    leftmargin=0pt,
    rightmargin=0pt,
    skipabove=1em,
    skipbelow=0.5em,
    #4,
  },
  ]{#1}
}

% Style 2: Full border (for examples)
\newcommand\createnewfullborderstyle[4]{
  \declaretheoremstyle[
  headfont=\bfseries\sffamily\color{#2}, bodyfont=\normalfont, #3,
  mdframed={
    rightline=true, leftline=true, topline=true, bottomline=true,
    linewidth=2pt,
    linecolor=#2!70!black,
    backgroundcolor=#2!5,
    roundcorner=3pt,
    innertopmargin=6pt,
    innerbottommargin=6pt,
    innerleftmargin=8pt,
    innerrightmargin=8pt,
    leftmargin=0pt,
    rightmargin=0pt,
    #4,
  },
  ]{#1}
}

% Legacy commands for backward compatibility
\newcommand\createnewtheoremstyle[3]{
  \declaretheoremstyle[
  headfont=\bfseries\sffamily, bodyfont=\normalfont, #2,
  mdframed={
    #3,
  },
  ]{#1}
}

\newcommand\createnewcoloredtheoremstyle[4]{
  \createnewvertlinestyle{#1}{#2}{#3}{#4}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Create the Environment Styles  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\makeatletter
% Always use colored environments for report
% Environments with color.
  \createnewcoloredtheoremstyle{thmdefinitionbox}{definition}{}{}
  \createnewcoloredtheoremstyle{thmtheorembox}{theorem}{}{}
  \createnewcoloredtheoremstyle{thmexamplebox}{example}{}{
    rightline=true, leftline=true, topline=true, bottomline=true,
    linewidth=2.5pt,
    linecolor=example!90!black,
    backgroundcolor=example!10,
    roundcorner=3pt
  }
  \createnewcoloredtheoremstyle{thmclaimbox}{claim}{}{}
  \createnewcoloredtheoremstyle{thmcorollarybox}{corollary}{}{}
  \createnewcoloredtheoremstyle{thmpropbox}{prop}{}{}
  \createnewcoloredtheoremstyle{thmlemmabox}{lemma}{}{}
  \createnewvertlinestyle{thmexercisebox}{exercise}{}{}
  \createnewvertlinestyle{thmproofbox}{proof}{qed=\qedsymbol}{backgroundcolor=proof!3}
  \createnewvertlinestyle{thmexplanationbox}{example}{qed=\qedsymbol}{backgroundcolor=example!3}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Create the Environments  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\declaretheorem[numberwithin=section, style=thmtheorembox,     name=Theorem]{theorem}
\declaretheorem[numberwithin=section, style=thmexamplebox,     name=Example]{example}
\declaretheorem[numberwithin=section, style=thmclaimbox,       name=Claim]{claim}
\declaretheorem[numberwithin=section, style=thmcorollarybox,   name=Corollary]{corollary}
\declaretheorem[numberwithin=section, style=thmpropbox,        name=Proposition]{prop}
\declaretheorem[numberwithin=section, style=thmlemmabox,       name=Lemma]{lemma}
\declaretheorem[numberwithin=section, style=thmexercisebox,    name=Exercise]{exercise}
\declaretheorem[numbered=no,          style=thmproofbox,       name=Proof]{replacementproof}
\declaretheorem[numbered=no,          style=thmexplanationbox, name=Proof]{expl}

\makeatletter
% Always use colored environments for report
% Environments with color.
  \newtcbtheorem[number within=section]{Definition}{Definition}{
    enhanced,
    before skip=4mm,
    after skip=4mm,
    colback=definition!3,
    colframe=definition!70!black,
    colbacktitle=definition!65!black,
    coltitle=white,
    boxrule=1.2pt,
    rounded corners=4pt,
    attach boxed title to top left={
      xshift=6mm,
      yshift*=-3mm
    },
    varwidth boxed title*=-3cm,
    boxed title style={
      enhanced,
      colback=definition!65!black,
      rounded corners=4pt,
      interior style={fill=definition!65!black}
    },
    fonttitle=\bfseries\sffamily,
    title={#2},
    #1
  }{def}

  \NewDocumentEnvironment{definition}{O{}O{}}
    {\begin{Definition}{#1}{#2}}{\end{Definition}}

  \newtcolorbox{note}[1][]{%
    enhanced,
    colback=cuhkbeige!10,%
    colframe=cuhkbeige!55!black,
    size=small,
    boxrule=1.2pt,
    rounded corners=4pt,
    title=\textbf{Note},
    halign title=flush left,
    coltitle=cuhkpurple!65!black,
    before skip=3mm,
    after skip=3mm,
    breakable,
    attach boxed title to top left={
      xshift=4mm,
      yshift*=-2mm
    },
    boxed title style={
      enhanced,
      colback=cuhkbeige!30,
      rounded corners=4pt,
      boxrule=0pt
    },
    #1,
  }

  \newtcbtheorem{Question}{Question}{enhanced,
    breakable,
    before skip=3mm,
    after skip=3mm,
    colback=myblue!3,
    colframe=myblue!70!black,
    colbacktitle=myblue!65!black,
    coltitle=white,
    boxrule=1.2pt,
    rounded corners=4pt,
    attach boxed title to top left={
      xshift=6mm,
      yshift*=-3mm
    },
    fonttitle=\bfseries\sffamily,
    title={Question: #2},
    boxed title style={
      enhanced,
      colback=myblue!65!black,
      rounded corners=4pt,
      boxrule=0pt
    },
    #1
  }{def}

  \NewDocumentEnvironment{question}{O{}O{}}
  {\begin{Question}{#1}{#2}}{\end{Question}}

  \newtcolorbox{Solution}[1][]{enhanced,
    breakable,
    before skip=3mm,
    after skip=3mm,
    colback=definition!4,
    colframe=definition!70!black,
    boxrule=0pt,
    leftrule=2pt,
    rightrule=0pt,
    toprule=0pt,
    bottomrule=0pt,
    rounded corners=3pt,
    left=8mm,
    right=4mm,
    top=3mm,
    bottom=3mm,
    fonttitle=\bfseries\sffamily\color{definition!70!black},
    title={\textbf{Solution\ifx\relax#1\relax\else: #1\fi}}
  }

  \NewDocumentEnvironment{solution}{O{}}
  {\vspace{-10pt}\begin{Solution}[#1]}{\end{Solution}}
}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Edit Proof Environment  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Proof environment - supports optional title and uses vertical line style
\renewenvironment{proof}[1][\proofname]{
  \begin{replacementproof}[#1]
}{%
  \end{replacementproof}
}

% Explanation environment - supports optional title and uses vertical line style
\newenvironment{explanation}[1][\proofname]{
  \begin{expl}[#1]
}{%
  \end{expl}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Generic Reusable Blocks Based on Colors and Styles                         %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Generic tcolorbox with vertical line style (left border only)
% Usage: \begin{vertlineblock}[color]{title}...\end{vertlineblock}
% Example: \begin{vertlineblock}[myorange]{Important Note}...\end{vertlineblock}
\newtcolorbox{vertlineblock}[2][]{
  enhanced,
  breakable,
  before skip=3mm,
  after skip=3mm,
  colback=#1!4,
  colframe=#1!70!black,
  boxrule=0pt,
  leftrule=2pt,
  rightrule=0pt,
  toprule=0pt,
  bottomrule=0pt,
  rounded corners=3pt,
  left=8mm,
  right=4mm,
  top=3mm,
  bottom=3mm,
  fonttitle=\bfseries\sffamily\color{#1!70!black},
  title={#2}
}

% Generic tcolorbox with full border style
% Usage: \begin{fullborderblock}[color]{title}...\end{fullborderblock}
% Example: \begin{fullborderblock}[cuhkgold]{Key Point}...\end{fullborderblock}
\newtcolorbox{fullborderblock}[2][]{
  enhanced,
  breakable,
  before skip=3mm,
  after skip=3mm,
  colback=#1!5,
  colframe=#1!70!black,
  boxrule=2pt,
  rounded corners=3pt,
  left=4mm,
  right=4mm,
  top=3mm,
  bottom=3mm,
  fonttitle=\bfseries\sffamily\color{#1!70!black},
  title={#2}
}

% Generic tcolorbox with title box style (colored title box attached to top)
% Usage: \begin{titleboxblock}[color]{title}...\end{titleboxblock}
\newtcolorbox{titleboxblock}[2][]{
  enhanced,
  breakable,
  before skip=3mm,
  after skip=3mm,
  colback=#1!3,
  colframe=#1!70!black,
  colbacktitle=#1!65!black,
  coltitle=white,
  boxrule=1.2pt,
  rounded corners=4pt,
  attach boxed title to top left={
    xshift=6mm,
    yshift*=-3mm
  },
  varwidth boxed title*=-3cm,
  boxed title style={
    enhanced,
    colback=#1!65!black,
    rounded corners=4pt,
    interior style={fill=#1!65!black}
  },
  fonttitle=\bfseries\sffamily,
  title={#2},
  left=4mm,
  right=4mm,
  top=3mm,
  bottom=3mm
}

% Generic highlight block with optional title
% Usage: \begin{highlightblock}[color]{title}...\end{highlightblock}
%        or \begin{highlightblock}[color]{}...\end{highlightblock} (no title)
% Example: \begin{highlightblock}[myblue]{Reminder}...\end{highlightblock}
% Note: Title uses white text on colored background for better contrast
\newtcolorbox{highlightblock}[2][]{
  enhanced,
  breakable,
  before skip=2mm,
  after skip=2mm,
  colback=#1!4,
  colframe=#1!70!black,
  colbacktitle=#1!65!black,
  coltitle=white,
  boxrule=1.2pt,
  rounded corners=4pt,
  left=4mm,
  right=4mm,
  top=3mm,
  bottom=3mm,
  fonttitle=\bfseries\sffamily,
  attach boxed title to top left={
    xshift=6mm,
    yshift*=-3mm
  },
  varwidth boxed title*=-3cm,
  boxed title style={
    enhanced,
    colback=#1!65!black,
    rounded corners=4pt,
    boxrule=0pt,
    interior style={fill=#1!65!black}
  },
  title={#2}
}

% Convenience environments using predefined colors
% Vertical line style blocks (left border only, like Exercise and Proof)
% Usage: \begin{purplevertblock}{title}...\end{purplevertblock}
\NewDocumentEnvironment{purplevertblock}{O{}}{%
  \begin{vertlineblock}[cuhkpurple]{#1}
}{%
  \end{vertlineblock}
}

\NewDocumentEnvironment{goldvertblock}{O{}}{%
  \begin{vertlineblock}[cuhkgold]{#1}
}{%
  \end{vertlineblock}
}

\NewDocumentEnvironment{greenvertblock}{O{}}{%
  \begin{vertlineblock}[mygreen]{#1}
}{%
  \end{vertlineblock}
}

\NewDocumentEnvironment{bluevertblock}{O{}}{%
  \begin{vertlineblock}[myblue]{#1}
}{%
  \end{vertlineblock}
}

\NewDocumentEnvironment{orangevertblock}{O{}}{%
  \begin{vertlineblock}[myorange]{#1}
}{%
  \end{vertlineblock}
}

% Title box style blocks (colored title box, like Definition)
% Usage: \begin{purpletitleblock}{title}...\end{purpletitleblock}
\NewDocumentEnvironment{purpletitleblock}{O{}}{%
  \begin{titleboxblock}[cuhkpurple]{#1}
}{%
  \end{titleboxblock}
}

\NewDocumentEnvironment{goldtitleblock}{O{}}{%
  \begin{titleboxblock}[cuhkgold]{#1}
}{%
  \end{titleboxblock}
}

\NewDocumentEnvironment{greentitleblock}{O{}}{%
  \begin{titleboxblock}[mygreen]{#1}
}{%
  \end{titleboxblock}
}

\NewDocumentEnvironment{bluetitleblock}{O{}}{%
  \begin{titleboxblock}[myblue]{#1}
}{%
  \end{titleboxblock}
}

% Full border style blocks (all sides, like Example)
% Usage: \begin{goldborderblock}{title}...\end{goldborderblock}
\NewDocumentEnvironment{goldborderblock}{O{}}{%
  \begin{fullborderblock}[cuhkgold]{#1}
}{%
  \end{fullborderblock}
}

\NewDocumentEnvironment{purpleborderblock}{O{}}{%
  \begin{fullborderblock}[cuhkpurple]{#1}
}{%
  \end{fullborderblock}
}

